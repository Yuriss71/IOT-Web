<!doctype html>
<html lang="fr" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <title>Dashboard • IOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-neutral-950 text-neutral-100 p-6">
    <header class="max-w-4xl mx-auto flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Dashboard</h1>
      <div class="flex items-center gap-3">
        <button id="logout" class="rounded-lg bg-neutral-800 px-3 py-2 border border-neutral-700 hover:bg-neutral-700">Logout</button>
      </div>
    </header>

    <main class="max-w-4xl mx-auto mt-6 grid md:grid-cols-3 gap-6">
      <section class="md:col-span-1 rounded-2xl border border-neutral-800 bg-neutral-900 p-4">
        <h2 class="font-medium mb-3">Ajouter un PIN</h2>
        <form id="addForm" class="grid gap-2 sm:grid-cols-[minmax(0,1fr)_auto]">
          <input id="pinInput" placeholder="PIN" class="w-full rounded-lg bg-neutral-800 border border-neutral-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-500" />
          <button class="rounded-lg bg-neutral-100 text-neutral-900 font-medium px-4 py-2 hover:bg-white sm:h-full">Ajouter</button>
        </form>
        <p id="addDeviceError" class="text-sm text-red-400 mt-2 hidden"></p>

        <hr class="border-neutral-800 my-4" />

        <h2 class="font-medium mb-3">Change RFID</h2>
        <form id="rfidForm" class="grid gap-2 sm:grid-cols-[minmax(0,1fr)_auto]">
          <input id="rfidInput" placeholder="RFID UID" value="00000000" class="w-full rounded-lg bg-neutral-800 border border-neutral-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neutral-500" />
          <button class="rounded-lg bg-neutral-100 text-neutral-900 font-medium px-4 py-2 hover:bg-white sm:h-full">Change RFID</button>
        </form>
        <p id="rfidError" class="text-sm text-red-400 mt-2 hidden"></p>
      </section>

      <section class="md:col-span-2 rounded-2xl border border-neutral-800 bg-neutral-900 p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium">Mes devices</h2>
          <div class="flex flex-col items-end gap-0.5">
            <span id="totalCount" class="text-lg font-semibold text-neutral-100">Total: 0</span>
            <span id="websocketStatus" class="text-xs text-neutral-400">WS: ...</span>
          </div>
        </div>
        <ul id="deviceList" class="mt-3 space-y-2"></ul>
      </section>

      <section class="md:col-span-3 rounded-2xl border border-neutral-800 bg-neutral-900 p-4">
        <h2 class="font-medium mb-3">Logs</h2>
        <pre id="logOutput" class="text-sm whitespace-pre-wrap"></pre>
      </section>
    </main>

    <script>
      const deviceList = document.getElementById('deviceList');
      const logOutput = document.getElementById('logOutput');
      const websocketStatus = document.getElementById('websocketStatus');
      const addDeviceError = document.getElementById('addDeviceError');
      const rfidError = document.getElementById('rfidError');
      const deviceMap = new Map(); // pin -> { count, mode }

      const MODE_LABELS = {
        increment: 'Increment (+1)',
        decrement: 'Decrement (-1)'
      };

      function describeMode(mode) {
        return MODE_LABELS[mode] || MODE_LABELS.increment;
      }

      function computeTotalCount() {
        let total = 0;
        for (const device of deviceMap.values()) {
          const value = typeof device.count === 'number' ? device.count : 0;
          total += value;
        }
        return total;
      }

      function updateTotalCountUI() {
        const totalElement = document.getElementById('totalCount');
        if (!totalElement) return;
        totalElement.textContent = 'Total: ' + computeTotalCount();
      }

      async function apiFetch(url, options = {}) {
        const opts = { credentials: 'include', ...options };
        opts.headers = Object.assign({ Accept: 'application/json' }, options.headers || {});
        if (opts.body && !('Content-Type' in opts.headers)) {
          opts.headers['Content-Type'] = 'application/json';
        }
        const response = await fetch(url, opts);
        if (response.status === 401) {
          location.href = '/login';
          throw new Error('Unauthorized');
        }
        return response;
      }

      document.getElementById('logout').onclick = async () => {
        try {
          await apiFetch('/api/auth/logout', { method: 'POST' });
        } catch (_) {
        } finally {
          location.href = '/login';
        }
      };

      function renderDevices(deviceRecords) {
        deviceList.innerHTML = '';
        deviceMap.clear();
        const pins = [];
        deviceRecords.forEach((device) => {
          const mode = (device.mode || 'increment').toLowerCase() === 'decrement' ? 'decrement' : 'increment';
          deviceMap.set(device.pin, { count: device.current_count, mode });
          pins.push(device.pin);
          const item = document.createElement('li');
          item.className = 'rounded-xl bg-neutral-800 border border-neutral-700 px-3 py-2 flex items-center justify-between gap-3 flex-wrap';
          item.id = `pin-${device.pin}`;

          const infoWrapper = document.createElement('div');
          infoWrapper.className = 'flex flex-col gap-1';

          const pinLabel = document.createElement('span');
          pinLabel.className = 'font-mono text-base';
          pinLabel.textContent = device.pin;

          const countLabel = document.createElement('span');
          countLabel.className = 'text-sm text-neutral-300';
          countLabel.innerHTML = `count: <b id='count-${device.pin}'>${device.current_count}</b>`;

          const modeLabel = document.createElement('span');
          modeLabel.className = 'text-xs text-neutral-400';
          modeLabel.id = `mode-${device.pin}`;
          modeLabel.textContent = `Mode actuel: ${describeMode(mode)}`;

          infoWrapper.append(pinLabel, countLabel, modeLabel);

          const actionsWrapper = document.createElement('div');
          actionsWrapper.className = 'flex items-center gap-2 flex-wrap justify-end';

          const toggleButton = document.createElement('button');
          toggleButton.className = 'rounded-lg bg-neutral-100 text-neutral-900 font-medium px-3 py-2 text-sm hover:bg-white transition disabled:opacity-60';
          toggleButton.id = `toggle-${device.pin}`;
          toggleButton.textContent = `Basculer`;
          toggleButton.addEventListener('click', () => toggleDeviceMode(device.pin));

          const deleteButton = document.createElement('button');
          deleteButton.className = 'rounded-lg bg-red-600 text-white font-medium px-3 py-2 text-sm hover:bg-red-500 transition disabled:opacity-60';
          deleteButton.id = `delete-${device.pin}`;
          deleteButton.textContent = 'Supprimer';
          deleteButton.addEventListener('click', () => deleteDevice(device.pin));

          actionsWrapper.append(toggleButton, deleteButton);

          item.append(infoWrapper, actionsWrapper);
          deviceList.appendChild(item);
        });
        updateTotalCountUI();
        return pins;
      }

      async function loadDevices() {
        const response = await apiFetch('/api/devices');
        if (!response.ok) throw new Error('Erreur API');
        const deviceRecords = await response.json();
        return renderDevices(deviceRecords);
      }

      function resolveTimestamp(entry) {
        if (!entry) return Math.floor(Date.now() / 1000);
        if (typeof entry.timestamp === 'number') return entry.timestamp;
        if (typeof entry.ts === 'number') return entry.ts;
        return Math.floor(Date.now() / 1000);
      }

      function formatLog(entry) {
          const timestamp = new Date(entry.ts * 1000).toLocaleTimeString();
          let changeText = '';

          console.log(entry)
          if (entry.enabled) {
              changeText = `✅ Le capteur RFID ${entry.uuid} a activé tous les devices`;
              return `[${timestamp}] Pin ${entry.pin} : ${changeText}`;
          } else if (entry.enabled === false) {
              if (entry.not_authorized) {
                  changeText = `⚠️ Le capteur RFID ${entry.uuid} n'est pas autorisé à changer l'état des devices`;
                  return `[${timestamp}] Pin ${entry.pin} : ${changeText}`;
              }
              changeText = `❌ Le capteur RFID ${entry.uuid} a désactivé tous les devices`;
              return `[${timestamp}] Pin ${entry.pin} : ${changeText}`;
          }
          if (entry.change > 0) {
              changeText = `➕ ${entry.change} entrée${entry.change > 1 ? 's' : ''}`;
          } else if (entry.change < 0) {
              changeText = `➖ ${Math.abs(entry.change)} entrée${Math.abs(entry.change) > 1 ? 's' : ''}`;
          } else {
              changeText = '0 changement';
          }

          return `[${timestamp}] Pin ${entry.pin} : ${changeText}, nouveau total = ${entry.new_count}`;
      }


      function prependLog(entry) {
        const formatted = formatLog(entry);
        logOutput.textContent = formatted + '\n' + logOutput.textContent;
      }

      async function loadInitialLogs(pins) {
        if (!pins.length) {
          logOutput.textContent = '';
          return;
        }
        const collectedLogs = [];
        for (const pin of pins) {
          try {
            const response = await apiFetch(`/api/logs/${encodeURIComponent(pin)}?limit=50`);
            if (!response.ok) continue;
            const logEntries = await response.json();
            logEntries.forEach((entry) => collectedLogs.push(entry));
          } catch (_) {
          }
        }
        collectedLogs.sort((a, b) => resolveTimestamp(b) - resolveTimestamp(a));
        logOutput.textContent = collectedLogs.map(formatLog).join('\n');
      }

      function updateDeviceCountUI(pin, newCount) {
        const counter = document.getElementById('count-' + pin);
        if (counter) counter.textContent = newCount;
      }

      function updateDeviceModeUI(pin, mode) {
        const normalized = mode === 'decrement' ? 'decrement' : 'increment';
        const label = document.getElementById(`mode-${pin}`);
        if (label) label.textContent = `Mode actuel: ${describeMode(normalized)}`;
        const button = document.getElementById(`toggle-${pin}`);
        if (button) button.textContent = `Basculer`;
      }

      async function toggleDeviceMode(pin) {
        const device = deviceMap.get(pin);
        if (!device) return;
        const button = document.getElementById(`toggle-${pin}`);
        const nextMode = device.mode === 'increment' ? 'decrement' : 'increment';
        if (button) button.disabled = true;
        try {
          const response = await apiFetch(`/api/devices/${encodeURIComponent(pin)}/mode`, {
            method: 'POST',
            body: JSON.stringify({ mode: nextMode })
          });
          if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: 'Erreur API' }));
            throw new Error(payload.detail || 'Erreur API');
          }
          const payload = await response.json();
          const updatedMode = ((payload.mode || nextMode) === 'decrement') ? 'decrement' : 'increment';
          device.mode = updatedMode;
          updateDeviceModeUI(pin, updatedMode);
        } catch (error) {
          alert(error.message || 'Impossible de changer de mode');
        } finally {
          if (button) button.disabled = false;
        }
      }

      async function deleteDevice(pin) {
        const deleteButton = document.getElementById(`delete-${pin}`);
        const toggleButton = document.getElementById(`toggle-${pin}`);
        if (!pin) return;
        if (!confirm(`Supprimer le device ${pin} ?`)) return;
        if (deleteButton) deleteButton.disabled = true;
        if (toggleButton) toggleButton.disabled = true;
        try {
          const response = await apiFetch('/api/deleteDevice', {
            method: 'POST',
            body: JSON.stringify({ pin })
          });
          if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: 'Erreur API' }));
            throw new Error(payload.detail || 'Erreur API');
          }
          const pins = await loadDevices();
          await loadInitialLogs(pins);
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ pins }));
          }
        } catch (error) {
          alert(error.message || 'Impossible de supprimer ce device');
        } finally {
          if (deleteButton) deleteButton.disabled = false;
          if (toggleButton) toggleButton.disabled = false;
        }
      }

      document.getElementById('addForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        addDeviceError.classList.add('hidden');
        const pin = document.getElementById('pinInput').value.trim();
        if (!pin) return;
        try {
          const response = await apiFetch('/api/devices', {
            method: 'POST',
            body: JSON.stringify({ pin })
          });
          if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: 'Erreur' }));
            throw new Error(payload.detail || 'Erreur');
          }
          document.getElementById('pinInput').value = '';
          const pins = await loadDevices();
          await loadInitialLogs(pins);
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ pins }));
          }
        } catch (error) {
          addDeviceError.textContent = error.message || 'Erreur';
          addDeviceError.classList.remove('hidden');
        }
      });

      document.getElementById('rfidForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        rfidError.classList.add('hidden');
        const rfid_uid = document.getElementById('rfidInput').value.trim() || '00000000';
        try {
          const response = await apiFetch('/api/rfid', {
            method: 'POST',
            body: JSON.stringify({ rfid_uid })
          });
          if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: 'Erreur' }));
            throw new Error(payload.detail || 'Erreur');
          }
        } catch (error) {
          rfidError.textContent = error.message || 'Erreur';
          rfidError.classList.remove('hidden');
        }
      });

      let socket = null;
      let heartbeatTimer = null;

      function connectWebsocket(pins) {
        socket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
        socket.onopen = () => {
          websocketStatus.textContent = 'WS: connecté';
          if (heartbeatTimer) clearInterval(heartbeatTimer);
          heartbeatTimer = setInterval(() => {
            if (socket && socket.readyState === WebSocket.OPEN) socket.send('ping');
          }, 15000);
          if (pins && pins.length) socket.send(JSON.stringify({ pins }));
        };
        socket.onclose = () => {
          websocketStatus.textContent = 'WS: déconnecté';
          if (heartbeatTimer) clearInterval(heartbeatTimer);
        };
        socket.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            if (message.type === 'subscribed') return;
            const { pin, change, new_count } = message;
            if (deviceMap.has(pin)) {
              deviceMap.get(pin).count = new_count;
              updateDeviceCountUI(pin, new_count);
            }
            updateTotalCountUI();
            prependLog(message);
          } catch (_) {
          }
        };
      }

      (async () => {
        try {
          const pins = await loadDevices();
          await loadInitialLogs(pins);
          connectWebsocket(pins);
        } catch (error) {
          if (error.message !== 'Unauthorized') {
            addDeviceError.textContent = error.message || 'Erreur';
            addDeviceError.classList.remove('hidden');
          }
        }
      })();
    </script>
  </body>
  </html>
